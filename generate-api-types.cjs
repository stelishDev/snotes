/*
Copyright (c) 2021 Nyriad Ltd. - All rights reserved.

All information contained herein is and remains the property of Nyriad Ltd. The
intellectual and technical concepts contained herein are proprietary to Nyriad
Ltd. and are covered by New Zealand, U.S. and Foreign Patents, patents in
process, and are  protected by trade secret, copyright law and intellectual
property laws. Dissemination of aforementioned information or reproduction of
this material or part thereof is strictly forbidden unless prior written
permission is obtained from Nyriad Ltd. Additionally this file is subject to the
terms and conditions of the product EULA and product user guide, which are both
available from Zendesk and form part of this software package.
*/
const { execSync } = require("child_process");
const { writeFile, writeFileSync } = require("fs");
const axios = require("axios");
const { generateApi } = require("swagger-typescript-api");
const { resolve } = require("path");

const swaggerJsonSnapshotFile = "api-spec.json";

const swaggerJsonUrl = process.argv[2];
console.log("Generate API types from: " + swaggerJsonUrl);

const options = {
  name: "api-types.ts",
  url: swaggerJsonUrl,
  output: resolve("./src/api/"),
  generateClient: false,
  disableStrictSSL: true,
};

const header = `/*
 * ---------------------------------------------------------------
 * ## DO NOT EDIT THIS FILE MANUALLY                            ##
 * ## THIS FILE WAS GENERATED VIA \`yarn generate-api-types\`     ##
 * ---------------------------------------------------------------
 */
/* eslint-disable @typescript-eslint/no-explicit-any */
`;

const run = async () => {
  try {
    const { files } = await generateApi(options);

    // overwrites the generated file with one without the eslint ignore header
    files.forEach(({ fileContent, fileName, fileExtension }) => {
      writeFile(
        resolve("./src/api/" + fileName + fileExtension),
        header + fileContent,
        "utf-8",
        (err) => {
          if (err) {
            console.error(reason);
          }
        }
      );
    });
  } catch (error) {
    console.error(error);
  }

  console.log("Updating Swagger JSON snapshot: " + swaggerJsonSnapshotFile);
  const response = await axios.get(swaggerJsonUrl);
  writeFileSync("./api-spec.json", JSON.stringify(response.data, undefined, 2));

  // execSync("yarn eslint **/api-types.ts --fix", { stdio: "inherit" });
};

run();
